<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Point le plus haut — OSM + SRTM</title>

<!-- Tailwind CSS -->
<script src="https://cdn.tailwindcss.com"></script>

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css" />

<style>
  html, body, #map { height: 100%; margin: 0; padding: 0; }
  .leaflet-control-container .leaflet-top { z-index: 1100; }
</style>
</head>
<body class="bg-slate-50 text-slate-800">

<div class="flex h-screen">
  <aside id="sidebar" class="w-96 p-4 border-r bg-white shadow-md z-20 overflow-auto">
    <h1 class="text-lg font-semibold mb-4">Trouver le point le plus haut</h1>

    <!-- Recherche lieu -->
    <div class="mb-3">
      <label class="block text-sm font-medium">Rechercher un lieu</label>
      <div class="flex gap-2 mt-2">
        <input id="searchInput" class="flex-1 px-3 py-2 border rounded" placeholder="Ville, adresse ou lieu...">
        <button id="searchBtn" class="px-3 py-2 bg-blue-600 text-white rounded">Rechercher</button>
      </div>
      <div id="searchResults" class="mt-2 text-xs text-slate-600"></div>
    </div>

    <!-- Options -->
    <div class="space-y-3">
      <div>
        <label class="block text-sm font-medium">Sélection (dessine un rectangle)</label>
        <p class="text-xs text-slate-500 mt-1">Utilise l'outil de dessin sur la carte à droite. Garde une seule sélection active.</p>
      </div>

      <div class="pt-2 border-t">
        <label class="inline-flex items-center">
          <input id="useGrid" type="checkbox" class="mr-2">
          <span class="text-sm">Échantillonner la zone avec SRTM si OSM n'a pas d'élévation</span>
        </label>
        <div class="mt-2 flex items-center gap-2">
          <label class="text-xs">Résolution</label>
          <input id="gridSize" type="number" min="6" max="80" value="15" class="w-20 px-2 py-1 border rounded">
          <span class="text-xs text-slate-500">(plus = plus précis)</span>
        </div>

        <label class="inline-flex items-center mt-3">
          <input id="mergeOSMTop" type="checkbox" class="mr-2" checked>
          <span class="text-sm">Fusionner OSM + SRTM (préférence OSM si disponible)</span>
        </label>

        <label class="inline-flex items-center mt-3">
          <input id="filterOutliers" type="checkbox" class="mr-2" checked>
          <span class="text-sm">Filtrer les valeurs aberrantes (tolérance automatique)</span>
        </label>
      </div>

      <!-- Styles -->
      <div class="pt-2 border-t">
        <label class="block text-sm font-medium">Style</label>
        <div class="mt-2 grid grid-cols-3 gap-2">
          <button class="styleBtn px-2 py-2 rounded border" data-style="Pro">Pro</button>
          <button class="styleBtn px-2 py-2 rounded border" data-style="Nature">Nature</button>
          <button class="styleBtn px-2 py-2 rounded border" data-style="Dark">Dark</button>
        </div>
      </div>

      <!-- Fond de carte -->
      <div class="pt-2 border-t">
        <label class="block text-sm font-medium">Fond de carte</label>
        <div class="mt-2 grid grid-cols-2 gap-2">
          <button class="basemapBtn px-2 py-2 rounded border" data-layer="osm">OSM Standard</button>
          <button class="basemapBtn px-2 py-2 rounded border" data-layer="ign">IGN Topographique</button>
          <button class="basemapBtn px-2 py-2 rounded border" data-layer="oaci">OACI France</button>
        </div>
      </div>

      <!-- Actions -->
      <div class="pt-2 border-t">
        <div class="flex gap-2">
          <button id="locateBtn" class="flex-1 px-3 py-2 rounded bg-emerald-600 text-white">Ma position</button>
          <button id="resetBtn" class="px-3 py-2 rounded border">Reset</button>
        </div>

        <div class="mt-3 grid grid-cols-2 gap-2">
          <button id="findBtn" class="px-3 py-2 bg-blue-600 text-white rounded">Trouver le point le plus haut</button>
          <button id="exportBtn" class="px-3 py-2 bg-slate-700 text-white rounded">Exporter (CSV / GeoJSON)</button>
        </div>

        <div id="status" class="mt-3 text-sm font-medium">Prêt.</div>
        <div id="log" class="mt-2 text-xs text-slate-600 max-h-36 overflow-auto"></div>

        <div class="pt-4 border-t mt-4">
          <button onclick="window.print()" class='w-full px-3 py-2 rounded bg-indigo-600 text-white'>Imprimer l'aide</button>
        </div>
      </div>
    </div>
  </aside>

  <main class="flex-1 relative">
    <div id="map" style="width:100%; height:100%"></div>
  </main>
</div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>

<script>
const OVERPASS_URL = 'https://overpass-api.de/api/interpreter';
const OPENTOPODATA_URL = 'https://api.opentopodata.org/v1/srtm90m';
const NOMINATIM_URL = 'https://nominatim.openstreetmap.org/search?format=json&limit=6&q=';

// Fond de carte
const osm = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', { attribution: '© OpenStreetMap' });
const ign = L.tileLayer('https://wxs.ign.fr/essentiels/geoportail/wmts?layer=GEOGRAPHICALGRIDSYSTEMS.MAPS.SCAN-EXPRESS.STANDARD&style=normal&tilematrixset=PM&Service=WMTS&Request=GetTile&Version=1.0.0&Format=image/png&TileMatrix={z}&TileCol={x}&TileRow={y}', { attribution: '© IGN' });
const oaci = L.tileLayer('https://tiles.openaip.net/{z}/{x}/{y}.png', { attribution: '© OACI France' });

const map = L.map('map', { layers: [osm] }).setView([46.8,2.4],6);
const baseMaps = { osm, ign, oaci };

// Draw rectangle
const drawnItems = new L.FeatureGroup();
map.addLayer(drawnItems);
const drawControl = new L.Control.Draw({ draw: { polygon:false, polyline:false, circle:false, marker:false, rectangle:{ shapeOptions:{ color:'#f06eaa' } } }, edit: { featureGroup: drawnItems } });
map.addControl(drawControl);
map.on(L.Draw.Event.CREATED, e => { drawnItems.clearLayers(); drawnItems.addLayer(e.layer); });

// Styles
document.querySelectorAll('.styleBtn').forEach(b=>b.addEventListener('click', ()=>{
  const s=b.dataset.style||'Pro';
  document.body.className = s==='Pro'?'bg-slate-50 text-slate-800':s==='Nature'?'bg-emerald-50 text-emerald-900':'bg-slate-900 text-slate-200';
}));

// Basemap switch
document.querySelectorAll('.basemapBtn').forEach(b=>b.addEventListener('click',()=>{
  const l=b.dataset.layer;
  Object.values(baseMaps).forEach(l
